image: golang:1.10.3

variables:
  PKG_NAME: gitlab.com/ignitionrobotics/web/fuelserver.git
  MYSQL_DATABASE: "cloudsim_test"
  MYSQL_ROOT_PASSWORD: "root"

before_script:
  - go version
  - mkdir -p -v $GOPATH/src/$PKG_NAME
  - mv -f * $GOPATH/src/$PKG_NAME
  - cd $GOPATH/src/$PKG_NAME
  - export DEP_RELEASE_TAG=v0.4.1
  - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
  - $GOPATH/bin/dep ensure
  - $GOPATH/bin/dep status
  - git config --global user.name "ign-cloudsim"
  - git config --global user.email "ign-cloudsim@test.org"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - /go/src/$PKG_NAME/vendor
    - /go/bin

stages:
  - formatting
  - linting
  - testing
  - building
  - packaging
  - deploying

format:
  stage: formatting
  script:
    - go fmt $(go list ./... | grep -v /vendor/)

lint:
  stage: linting
  before_script:
    - go get -u golang.org/x/lint/golint
  script:
    - golint -set_exit_status $(go list ./... | grep -v /vendor/)

vet:
  stage: testing
  script:
    - go vet $(go list ./... | grep -v /vendor/)
  services:
    - mysql:5.7
  environment:
    name: testing

test:
  stage: testing
  script:
    - go test $(go list ./... | grep -v /vendor/)
  services:
    - mysql:5.7
  environment:
    name: testing

race:
  stage: testing
  script:
    - go test -race $(go list ./... | grep -v /vendor/)
  services:
    - mysql:5.7
  environment:
    name: testing

coverage:
  stage: testing
  script:
    - go test -covermode=atomic -coverprofile=coverage.tx
    - go tool cover -func=coverage.tx
    - bash <(curl -s https://codecov.io/bash)
  services:
    - mysql:5.7
  environment:
    name: testing

build:
  stage: building
  script:
    - go build

package:
  stage: packaging
  script:
    - echo "Packaging"


integration:
  stage: deploying
  script:
    - echo "Deploying to integration"
  environment:
    name: integration
    url: https://web-cloudsim-integration.us-east-1.elasticbeanstalk.com/1.0
  except:
    - master
    - develop
  when: manual

staging:
  stage: deploying
  script:
    - echo "Deploying to staging"
  environment:
    name: staging
    url: https://web-cloudsim-staging.us-east-1.elasticbeanstalk.com/1.0
  only:
    - develop
  when: manual

production:
  stage: deploying
  script:
    - echo "Deploying to production"
  environment:
    name: production
    url: https://web-cloudsim-production.us-east-1.elasticbeanstalk.com/1.0
  only:
    - master
  when: manual

